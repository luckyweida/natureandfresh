(function($){var _media=acf.media;acf.fields.file={$el:null,$input:null,o:{},set:function(o){$.extend(this,o);this.$input=this.$el.find('input[type="hidden"]');this.o=acf.helpers.get_atts(this.$el);this.o.multiple=this.$el.closest(".repeater").exists()?true:false;this.o.query={};if(this.o.library=="uploadedTo"){this.o.query.uploadedTo=acf.o.post_id}return this},init:function(){if(acf.helpers.is_clone_field(this.$input)){return}},add:function(file){var div=_media.div;div.find(".acf-file-icon").attr("src",file.icon);div.find(".acf-file-title").text(file.title);div.find(".acf-file-name").text(file.name).attr("href",file.url);div.find(".acf-file-size").text(file.size);div.find(".acf-file-value").val(file.id).trigger("change");div.addClass("active");div.closest(".field").removeClass("error")},new_frame:function(attributes){_media.div=this.$el;_media.clear_frame();attributes.states=[];attributes.states.push(new wp.media.controller.Library({library:wp.media.query(this.o.query),multiple:attributes.multiple,title:attributes.title,priority:20,filterable:"all"}));if(acf.helpers.isset(wp,"media","controller","EditImage")){attributes.states.push(new wp.media.controller.EditImage)}_media.frame=wp.media(attributes);_media.frame.on("content:render:edit-image",function(){var image=this.state().get("image"),view=new wp.media.view.EditImage({model:image,controller:this}).render();this.content.set(view);view.loadEditor()},_media.frame);_media.frame.on("toolbar:create:select",function(toolbar){toolbar.view=new wp.media.view.Toolbar.Select({text:attributes.button.text,controller:this})},_media.frame);return _media.frame},edit:function(){var id=this.$input.val();this.new_frame({title:acf.l10n.file.edit,multiple:false,button:{text:acf.l10n.file.update}});_media.frame.on("open",function(){if(_media.frame.content._mode!="browse"){_media.frame.content.mode("browse")}_media.frame.$el.closest(".media-modal").addClass("acf-media-modal acf-expanded");var selection=_media.frame.state().get("selection"),attachment=wp.media.attachment(id);if($.isEmptyObject(attachment.changed)){attachment.fetch()}selection.add(attachment)});_media.frame.on("close",function(){_media.frame.$el.closest(".media-modal").removeClass("acf-media-modal")});acf.media.frame.open()},remove:function(){this.$el.find(".acf-file-icon").attr("src","");this.$el.find(".acf-file-title").text("");this.$el.find(".acf-file-name").text("").attr("href","");this.$el.find(".acf-file-size").text("");this.$el.find(".acf-file-value").val("").trigger("change");this.$el.removeClass("active")},popup:function(){var t=this;this.new_frame({title:acf.l10n.file.select,multiple:t.o.multiple,button:{text:acf.l10n.file.select}});acf.media.frame.on("content:activate",function(){var toolbar=null,filters=null;try{toolbar=acf.media.frame.content.get().toolbar;filters=toolbar.get("filters")}catch(e){}if(!filters){return false}if(t.o.library=="uploadedTo"){filters.$el.find('option[value="uploaded"]').remove();filters.$el.after("<span>"+acf.l10n.file.uploadedTo+"</span>");$.each(filters.filters,function(k,v){v.props.uploadedTo=acf.o.post_id})}});acf.media.frame.on("select",function(){selection=_media.frame.state().get("selection");if(selection){var i=0;selection.each(function(attachment){i++;if(i>1){var $td=_media.div.closest("td"),$tr=$td.closest(".row"),$repeater=$tr.closest(".repeater"),key=$td.attr("data-field_key"),selector="td .acf-file-uploader:first";if(key){selector='td[data-field_key="'+key+'"] .acf-file-uploader'}if(!$tr.next(".row").exists()){$repeater.find(".add-row-end").trigger("click")}_media.div=$tr.next(".row").find(selector)}var file={id:attachment.id,title:attachment.attributes.title,name:attachment.attributes.filename,url:attachment.attributes.url,icon:attachment.attributes.icon,size:attachment.attributes.filesize};acf.fields.file.add(file)})}});acf.media.frame.open();return false}};$(document).on("click",".acf-file-uploader .acf-button-edit",function(e){e.preventDefault();acf.fields.file.set({$el:$(this).closest(".acf-file-uploader")}).edit()});$(document).on("click",".acf-file-uploader .acf-button-delete",function(e){e.preventDefault();acf.fields.file.set({$el:$(this).closest(".acf-file-uploader")}).remove()});$(document).on("click",".acf-file-uploader .add-file",function(e){e.preventDefault();acf.fields.file.set({$el:$(this).closest(".acf-file-uploader")}).popup()})})(jQuery);