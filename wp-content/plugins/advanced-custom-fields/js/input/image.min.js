(function($){var _media=acf.media;acf.fields.image={$el:null,$input:null,o:{},set:function(o){$.extend(this,o);this.$input=this.$el.find('input[type="hidden"]');this.o=acf.helpers.get_atts(this.$el);this.o.multiple=this.$el.closest(".repeater").exists()?true:false;this.o.query={type:"image"};if(this.o.library=="uploadedTo"){this.o.query.uploadedTo=acf.o.post_id}return this},init:function(){if(acf.helpers.is_clone_field(this.$input)){return}},add:function(image){var div=_media.div;div.find(".acf-image-image").attr("src",image.url);div.find(".acf-image-value").val(image.id).trigger("change");div.addClass("active");div.closest(".field").removeClass("error")},new_frame:function(attributes){_media.div=this.$el;_media.clear_frame();attributes.states=[];attributes.states.push(new wp.media.controller.Library({library:wp.media.query(this.o.query),multiple:attributes.multiple,title:attributes.title,priority:20,filterable:"all"}));if(acf.helpers.isset(wp,"media","controller","EditImage")){attributes.states.push(new wp.media.controller.EditImage)}_media.frame=wp.media(attributes);_media.frame.on("content:render:edit-image",function(){var image=this.state().get("image"),view=new wp.media.view.EditImage({model:image,controller:this}).render();this.content.set(view);view.loadEditor()},_media.frame);_media.frame.on("toolbar:create:select",function(toolbar){toolbar.view=new wp.media.view.Toolbar.Select({text:attributes.button.text,controller:this})},_media.frame);return _media.frame},edit:function(){var id=this.$input.val();this.new_frame({title:acf.l10n.image.edit,multiple:false,button:{text:acf.l10n.image.update}});_media.frame.on("open",function(){if(_media.frame.content._mode!="browse"){_media.frame.content.mode("browse")}_media.frame.$el.closest(".media-modal").addClass("acf-media-modal acf-expanded");var selection=_media.frame.state().get("selection"),attachment=wp.media.attachment(id);if($.isEmptyObject(attachment.changed)){attachment.fetch()}selection.add(attachment)});_media.frame.on("close",function(){_media.frame.$el.closest(".media-modal").removeClass("acf-media-modal")});_media.frame.open()},remove:function(){this.$el.find(".acf-image-image").attr("src","");this.$el.find(".acf-image-value").val("").trigger("change");this.$el.removeClass("active")},popup:function(){var t=this;this.new_frame({title:acf.l10n.image.select,multiple:t.o.multiple,button:{text:acf.l10n.image.select}});_media.frame.on("content:activate",function(){var toolbar=null,filters=null;try{toolbar=acf.media.frame.content.get().toolbar;filters=toolbar.get("filters")}catch(e){}if(!filters){return false}$.each(filters.filters,function(k,v){v.props.type="image"});if(t.o.library=="uploadedTo"){filters.$el.find('option[value="uploaded"]').remove();filters.$el.after("<span>"+acf.l10n.image.uploadedTo+"</span>");$.each(filters.filters,function(k,v){v.props.uploadedTo=acf.o.post_id})}filters.$el.find("option").each(function(){var v=$(this).attr("value");if(v=="uploaded"&&t.o.library=="all"){return}if(v.indexOf("image")===-1){$(this).remove()}});filters.$el.val("image").trigger("change")});acf.media.frame.on("select",function(){selection=_media.frame.state().get("selection");if(selection){var i=0;selection.each(function(attachment){i++;if(i>1){var $td=_media.div.closest("td"),$tr=$td.closest(".row"),$repeater=$tr.closest(".repeater"),key=$td.attr("data-field_key"),selector="td .acf-image-uploader:first";if(key){selector='td[data-field_key="'+key+'"] .acf-image-uploader'}if(!$tr.next(".row").exists()){$repeater.find(".add-row-end").trigger("click")}_media.div=$tr.next(".row").find(selector)}var image={id:attachment.id,url:attachment.attributes.url};if(attachment.attributes.sizes&&attachment.attributes.sizes[t.o.preview_size]){image.url=attachment.attributes.sizes[t.o.preview_size].url}acf.fields.image.add(image)})}});acf.media.frame.open();return false},text:{title_add:"Select Image",title_edit:"Edit Image"}};$(document).on("click",".acf-image-uploader .acf-button-edit",function(e){e.preventDefault();acf.fields.image.set({$el:$(this).closest(".acf-image-uploader")}).edit()});$(document).on("click",".acf-image-uploader .acf-button-delete",function(e){e.preventDefault();acf.fields.image.set({$el:$(this).closest(".acf-image-uploader")}).remove()});$(document).on("click",".acf-image-uploader .add-image",function(e){e.preventDefault();acf.fields.image.set({$el:$(this).closest(".acf-image-uploader")}).popup()})})(jQuery);