(function($){acf.fields.relationship={$el:null,$input:null,$left:null,$right:null,o:{},timeout:null,set:function(o){$.extend(this,o);this.$input=this.$el.children('input[type="hidden"]');this.$left=this.$el.find(".relationship_left"),this.$right=this.$el.find(".relationship_right");this.o=acf.helpers.get_atts(this.$el);return this},init:function(){var _this=this;if(acf.helpers.is_clone_field(this.$input)){return}this.$right.find(".relationship_list").height(this.$left.height()-2);this.$right.find(".relationship_list").sortable({axis:"y",items:"> li",forceHelperSize:true,forcePlaceholderSize:true,scroll:true,update:function(){_this.$input.trigger("change")}});var $el=this.$el;this.$left.find(".relationship_list").scrollTop(0).on("scroll",function(e){if($el.hasClass("loading")||$el.hasClass("no-results")){return}if($(this).scrollTop()+$(this).innerHeight()>=$(this).get(0).scrollHeight){var paged=parseInt($el.attr("data-paged"));$el.attr("data-paged",paged+1);_this.set({$el:$el}).fetch()}});this.fetch()},fetch:function(){var _this=this,$el=this.$el;$el.addClass("loading");$.ajax({url:acf.o.ajaxurl,type:"post",dataType:"json",data:$.extend({action:"acf/fields/relationship/query_posts",post_id:acf.o.post_id,nonce:acf.o.nonce},this.o),success:function(json){_this.set({$el:$el}).render(json)}})},render:function(json){var _this=this;this.$el.removeClass("no-results").removeClass("loading");if(this.o.paged==1){this.$el.find(".relationship_left li:not(.load-more)").remove()}if(!json||!json.html){this.$el.addClass("no-results");return}this.$el.find(".relationship_left .load-more").before(json.html);if(!json.next_page_exists){this.$el.addClass("no-results")}this.$left.find("a").each(function(){var id=$(this).attr("data-post_id");if(_this.$right.find('a[data-post_id="'+id+'"]').exists()){$(this).parent().addClass("hide")}})},add:function($a){var id=$a.attr("data-post_id"),title=$a.html();if(this.$right.find("a").length>=this.o.max){alert(acf.l10n.relationship.max.replace("{max}",this.o.max));return false}if($a.parent().hasClass("hide")){return false}$a.parent().addClass("hide");var html=["<li>",'<a href="#" data-post_id="'+$a.attr("data-post_id")+'">',$a.html()+'<span class="acf-button-remove"></span>',"</a>",'<input type="hidden" name="'+this.$input.attr("name")+'[]" value="'+$a.attr("data-post_id")+'" />',"</li>"].join("");this.$right.find(".relationship_list").append(html);this.$input.trigger("change");this.$el.closest(".field").removeClass("error")},remove:function($a){$a.parent().remove();this.$left.find('a[data-post_id="'+$a.attr("data-post_id")+'"]').parent("li").removeClass("hide");this.$input.trigger("change")}};$(document).on("acf/setup_fields",function(e,el){$(el).find(".acf_relationship").each(function(){acf.fields.relationship.set({$el:$(this)}).init()})});$(document).on("change",".acf_relationship .select-post_type",function(e){var val=$(this).val(),$el=$(this).closest(".acf_relationship");$el.attr("data-post_type",val);$el.attr("data-paged",1);acf.fields.relationship.set({$el:$el}).fetch()});$(document).on("click",".acf_relationship .relationship_left .relationship_list a",function(e){e.preventDefault();acf.fields.relationship.set({$el:$(this).closest(".acf_relationship")}).add($(this));$(this).blur()});$(document).on("click",".acf_relationship .relationship_right .relationship_list a",function(e){e.preventDefault();acf.fields.relationship.set({$el:$(this).closest(".acf_relationship")}).remove($(this));$(this).blur()});$(document).on("keyup",".acf_relationship input.relationship_search",function(e){var val=$(this).val(),$el=$(this).closest(".acf_relationship");$el.attr("data-s",val);$el.attr("data-paged",1);clearTimeout(acf.fields.relationship.timeout);acf.fields.relationship.timeout=setTimeout(function(){acf.fields.relationship.set({$el:$el}).fetch()},500)});$(document).on("keypress",".acf_relationship input.relationship_search",function(e){if(e.which==13){e.preventDefault()}})})(jQuery);