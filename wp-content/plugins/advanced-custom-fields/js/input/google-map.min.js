(function($){acf.fields.google_map={$el:null,$input:null,o:{},api:{sensor:false,libraries:"places"},ready:false,geocoder:false,map:false,maps:{},set:function(o){$.extend(this,o);this.$input=this.$el.find(".input-address");this.o=acf.helpers.get_atts(this.$el);if(this.maps[this.o.id]){this.map=this.maps[this.o.id]}return this},init:function(){if(!this.geocoder){this.geocoder=new google.maps.Geocoder}this.ready=true;if(acf.helpers.is_clone_field(this.$input)){return}this.render()},render:function(){var _this=this,_$el=this.$el;var args={zoom:parseInt(this.o.zoom),center:new google.maps.LatLng(this.o.lat,this.o.lng),mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(this.$el.find(".canvas")[0],args);var autocomplete=new google.maps.places.Autocomplete(this.$el.find(".search")[0]);autocomplete.map=this.map;autocomplete.bindTo("bounds",this.map);this.map.marker=new google.maps.Marker({draggable:true,raiseOnDrag:true,map:this.map});this.map.$el=this.$el;var lat=this.$el.find(".input-lat").val(),lng=this.$el.find(".input-lng").val();if(lat&&lng){this.update(lat,lng).center()}google.maps.event.addListener(autocomplete,"place_changed",function(e){var $el=this.map.$el;var address=$el.find(".search").val();$el.find(".input-address").val(address);$el.find(".title h4").text(address);var place=this.getPlace();if(place.geometry){var lat=place.geometry.location.lat(),lng=place.geometry.location.lng();_this.set({$el:$el}).update(lat,lng).center()}else{_this.geocoder.geocode({address:address},function(results,status){if(status!=google.maps.GeocoderStatus.OK){console.log("Geocoder failed due to: "+status);return}if(!results[0]){console.log("No results found");return}place=results[0];var lat=place.geometry.location.lat(),lng=place.geometry.location.lng();_this.set({$el:$el}).update(lat,lng).center()})}});google.maps.event.addListener(this.map.marker,"dragend",function(){var $el=this.map.$el;var position=this.map.marker.getPosition(),lat=position.lat(),lng=position.lng();_this.set({$el:$el}).update(lat,lng).sync()});google.maps.event.addListener(this.map,"click",function(e){var $el=this.$el;var lat=e.latLng.lat(),lng=e.latLng.lng();_this.set({$el:$el}).update(lat,lng).sync()});this.maps[this.o.id]=this.map},update:function(lat,lng){var latlng=new google.maps.LatLng(lat,lng);this.$el.find(".input-lat").val(lat);this.$el.find(".input-lng").val(lng).trigger("change");this.map.marker.setPosition(latlng);this.map.marker.setVisible(true);this.$el.addClass("active");this.$el.closest(".field").removeClass("error");return this},center:function(){var position=this.map.marker.getPosition(),lat=this.o.lat,lng=this.o.lng;if(position){lat=position.lat();lng=position.lng()}var latlng=new google.maps.LatLng(lat,lng);this.map.setCenter(latlng)},sync:function(){var $el=this.$el;var position=this.map.marker.getPosition(),latlng=new google.maps.LatLng(position.lat(),position.lng());this.geocoder.geocode({latLng:latlng},function(results,status){if(status!=google.maps.GeocoderStatus.OK){console.log("Geocoder failed due to: "+status);return}if(!results[0]){console.log("No results found");return}var location=results[0];$el.find(".title h4").text(location.formatted_address);$el.find(".input-address").val(location.formatted_address).trigger("change")});return this},locate:function(){var _this=this,_$el=this.$el;if(!navigator.geolocation){alert(acf.l10n.google_map.browser_support);return this}_$el.find(".title h4").text(acf.l10n.google_map.locating+"...");_$el.addClass("active");navigator.geolocation.getCurrentPosition(function(position){var lat=position.coords.latitude,lng=position.coords.longitude;_this.set({$el:_$el}).update(lat,lng).sync().center()})},clear:function(){this.$el.removeClass("active");this.$el.find(".search").val("");this.$el.find(".input-address").val("");this.$el.find(".input-lat").val("");this.$el.find(".input-lng").val("");this.map.marker.setVisible(false)},edit:function(){this.$el.removeClass("active");var val=this.$el.find(".title h4").text();this.$el.find(".search").val(val).focus()},refresh:function(){google.maps.event.trigger(this.map,"resize");this.center()}};$(document).on("acf/setup_fields",function(e,el){var self=acf.fields.google_map;var $fields=$(el).find(".acf-google-map");if(!$fields.exists())return false;if(!acf.helpers.isset(window,"google","load")){$.getScript("https://www.google.com/jsapi",function(){google.load("maps","3",{other_params:$.param(self.api),callback:function(){$fields.each(function(){acf.fields.google_map.set({$el:$(this)}).init()})}})});return false}if(!acf.helpers.isset(window,"google","maps","places")){google.load("maps","3",{other_params:$.param(self.api),callback:function(){$fields.each(function(){acf.fields.google_map.set({$el:$(this)}).init()})}});return false}$fields.each(function(){acf.fields.google_map.set({$el:$(this)}).init()});return true});$(document).on("click",".acf-google-map .acf-sprite-remove",function(e){e.preventDefault();acf.fields.google_map.set({$el:$(this).closest(".acf-google-map")}).clear();$(this).blur()});$(document).on("click",".acf-google-map .acf-sprite-locate",function(e){e.preventDefault();acf.fields.google_map.set({$el:$(this).closest(".acf-google-map")}).locate();$(this).blur()});$(document).on("click",".acf-google-map .title h4",function(e){e.preventDefault();acf.fields.google_map.set({$el:$(this).closest(".acf-google-map")}).edit()});$(document).on("keydown",".acf-google-map .search",function(e){if(e.which==13){return false}});$(document).on("blur",".acf-google-map .search",function(e){var $el=$(this).closest(".acf-google-map");if($el.find(".input-lat").val()){$el.addClass("active")}});$(document).on("acf/fields/tab/show acf/conditional_logic/show",function(e,$field){if(!acf.fields.google_map.ready){return}if($field.attr("data-field_type")=="google_map"){acf.fields.google_map.set({$el:$field.find(".acf-google-map")}).refresh()}})})(jQuery);